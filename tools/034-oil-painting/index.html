<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oil Painting Effect | æ²¹ç•«æ•ˆæœ</title>
    <meta name="description" content="Turn your photos into oil paintings using local GPU acceleration.">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <!-- Language Switcher -->
        <div class="lang-switcher">
            <button id="lang-zh" class="lang-btn active">ç¹é«”ä¸­æ–‡</button>
            <button id="lang-en" class="lang-btn">English</button>
        </div>

        <!-- Header -->
        <header class="header">
            <h1 data-i18n="title">æ²¹ç•«æ•ˆæœ</h1>
            <p class="subtitle" data-i18n="subtitle">å°‡ç…§ç‰‡è½‰æ›ç‚ºæ²¹ç•«é¢¨æ ¼ï¼Œæ”¯æ´å³æ™‚é è¦½èˆ‡èª¿æ•´</p>
        </header>

        <!-- Privacy Badge -->
        <div class="privacy-badge">
            <span class="badge-icon">ğŸ”’</span>
            <span data-i18n="privacyBadge">100% æœ¬åœ°è™•ç† Â· é›¶è³‡æ–™ä¸Šå‚³</span>
        </div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Upload Area -->
            <div class="upload-area" id="uploadArea">
                <input type="file" id="fileInput" accept="image/png,image/jpeg,image/webp" hidden>
                <div class="upload-icon">ğŸ¨</div>
                <p class="upload-text" data-i18n="uploadText">é»æ“Šæˆ–æ‹–æ”¾åœ–ç‰‡åˆ°é€™è£¡</p>
                <p class="upload-hint" data-i18n="uploadHint">æ”¯æ´ JPGã€PNGã€WebP æ ¼å¼</p>
            </div>

            <!-- Editor Area -->
            <div class="editor-area" id="editorArea" style="display: none;">
                <div class="editor-layout">
                    <!-- Canvas Section -->
                    <div class="canvas-section">
                        <canvas id="previewCanvas"></canvas>
                        <div class="canvas-info">
                            <span data-i18n="resolution">è§£æåº¦</span>: <span id="resolutionVal">-</span>
                        </div>
                    </div>

                    <!-- Controls Section -->
                    <div class="controls-section">
                        <h3 data-i18n="settings">æ•ˆæœè¨­å®š</h3>

                        <!-- Radius -->
                        <div class="control-group">
                            <label data-i18n="radius">ç­†è§¸å¤§å°</label>
                            <div class="slider-with-input">
                                <input type="range" id="radiusSlider" min="1" max="20" value="4">
                                <span id="radiusValue">4</span>
                            </div>
                            <p class="help-text" data-i18n="radiusHelp">æ§åˆ¶æ²¹ç•«ç­†è§¸çš„å¤§å°èˆ‡ç´°ç¯€ç¨‹åº¦</p>
                        </div>

                        <!-- Intensity -->
                        <div class="control-group">
                            <label data-i18n="intensity">è‰²å½©å±¤æ¬¡</label>
                            <div class="slider-with-input">
                                <input type="range" id="intensitySlider" min="1" max="50" value="10">
                                <span id="intensityValue">10</span>
                            </div>
                            <p class="help-text" data-i18n="intensityHelp">æ§åˆ¶è‰²å½©çš„è±å¯Œåº¦èˆ‡åˆ†å±¤</p>
                        </div>

                        <!-- Action Buttons -->
                        <div class="action-buttons">
                            <button id="resetBtn" class="btn btn-secondary" data-i18n="reset">é‡è¨­</button>
                            <button id="downloadBtn" class="btn btn-primary" data-i18n="download">ä¸‹è¼‰çµæœ</button>
                        </div>

                        <button id="newImageBtn" class="btn btn-outline" data-i18n="newImage">é¸æ“‡æ–°åœ–ç‰‡</button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Use Cases -->
        <section class="use-cases-section">
            <h2 data-i18n="useCases">ä½¿ç”¨å ´æ™¯</h2>
            <div class="use-cases-grid">
                <div class="use-case">
                    <span class="use-case-icon">ğŸ–¼ï¸</span>
                    <span data-i18n="useCaseArt">è—è¡“å‰µä½œ</span>
                </div>
                <div class="use-case">
                    <span class="use-case-icon">ğŸ</span>
                    <span data-i18n="useCaseGift">å€‹æ€§åŒ–ç¦®ç‰©</span>
                </div>
                <div class="use-case">
                    <span class="use-case-icon">ğŸ“±</span>
                    <span data-i18n="useCaseSocial">ç¤¾ç¾¤åˆ†äº«</span>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="footer">
            <p>
                <a href="../README.md" data-i18n="backToHome">è¿”å›é¦–é </a> Â·
                <span data-i18n="toolNumber">å·¥å…· #034</span>
            </p>
            <p class="copyright" data-i18n="copyright">Awesome AI Local Tools Â© 2024</p>
        </footer>
    </div>

    <!-- Shaders -->
    <script id="vs" type="x-shader/x-vertex">
        attribute vec2 position;
        attribute vec2 texCoord;
        varying vec2 vTexCoord;
        void main() {
            gl_Position = vec4(position, 0.0, 1.0);
            vTexCoord = texCoord;
        }
    </script>

    <script id="fs" type="x-shader/x-fragment">
        precision mediump float;
        uniform sampler2D uImage;
        uniform vec2 uResolution;
        uniform int uRadius;
        uniform float uIntensityLevel; // Not strictly used in standard Kuwahara but can affect quantization

        varying vec2 vTexCoord;

        void main() {
            vec2 src_size = uResolution;
            vec2 uv = vTexCoord;
            float n = float((uRadius + 1) * (uRadius + 1));
            int i;
            int j;
            vec3 m[4];
            vec3 s[4];
            for (int k = 0; k < 4; ++k) {
                m[k] = vec3(0.0);
                s[k] = vec3(0.0);
            }

            // Kuwahara Filter
            // Loop for 4 quadrants
            // This is computationally expensive in WebGL for large radius

            // Optimization: Unroll or simplified loops
            // For radius 4, loop -4 to 0, 0 to 4

            // Region 0: -radius, -radius to 0, 0
            for (int j = -20; j <= 0; ++j)  {
                if(j < -uRadius) continue;
                for (int i = -20; i <= 0; ++i)  {
                    if(i < -uRadius) continue;
                    vec3 c = texture2D(uImage, uv + vec2(float(i),float(j)) / src_size).rgb;
                    m[0] += c;
                    s[0] += c * c;
                }
            }

            // Region 1: 0, -radius to radius, 0
            for (int j = -20; j <= 0; ++j)  {
                if(j < -uRadius) continue;
                for (int i = 0; i <= 20; ++i)  {
                    if(i > uRadius) continue;
                    vec3 c = texture2D(uImage, uv + vec2(float(i),float(j)) / src_size).rgb;
                    m[1] += c;
                    s[1] += c * c;
                }
            }

            // Region 2: 0, 0 to radius, radius
            for (int j = 0; j <= 20; ++j)  {
                if(j > uRadius) continue;
                for (int i = 0; i <= 20; ++i)  {
                    if(i > uRadius) continue;
                    vec3 c = texture2D(uImage, uv + vec2(float(i),float(j)) / src_size).rgb;
                    m[2] += c;
                    s[2] += c * c;
                }
            }

            // Region 3: -radius, 0 to 0, radius
            for (int j = 0; j <= 20; ++j)  {
                if(j > uRadius) continue;
                for (int i = -20; i <= 0; ++i)  {
                    if(i < -uRadius) continue;
                    vec3 c = texture2D(uImage, uv + vec2(float(i),float(j)) / src_size).rgb;
                    m[3] += c;
                    s[3] += c * c;
                }
            }

            float min_sigma2 = 1e+2;
            vec3 col = vec3(0.0);

            // Find quadrant with min variance
            for (int k = 0; k < 4; ++k) {
                m[k] /= n;
                s[k] = abs(s[k] / n - m[k] * m[k]);
                float sigma2 = s[k].r + s[k].g + s[k].b;
                if (sigma2 < min_sigma2) {
                    min_sigma2 = sigma2;
                    col = m[k];
                }
            }

            // Simple quantization for "Intensity Level"
            // col = floor(col * uIntensityLevel) / uIntensityLevel;

            gl_FragColor = vec4(col, 1.0);
        }
    </script>

    <script type="module" src="app.js"></script>
</body>
</html>
